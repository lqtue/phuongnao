<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnam Administrative Ward Finder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }


        .result {
            margin-top: 30px;
            padding: 20px;
            background: #e0f3ff;
            border-radius: 15px;
            color: white;
            display: none;
        }

        .error {
            background: #ffe9e9;
        }

        .ward-info {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .ward-name {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
            color: #667eea;
        }

        .ward-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .ward-table th, .ward-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .ward-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }


        .directions-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto;
        }


        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            margin-top: 20px;
        }

        .suggestions {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
            display: none;
            z-index: 1000;
            position: relative;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }


        .info {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Tra C·ª©u Ph∆∞·ªùng X√£ M·ªõi</h1>
        
        <div class="info">
            T√¨m ph∆∞·ªùng x√£ m·ªõi theo ranh gi·ªõi h√†nh ch√≠nh ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh c·ªßa Vi·ªát Nam. S·ª≠ d·ª•ng v·ªã tr√≠ hi·ªán t·∫°i ho·∫∑c t√¨m ki·∫øm ƒë·ªãa ch·ªâ b·∫•t k·ª≥.
        </div>

        <div class="input-group">
            <button id="locationBtn" class="btn">üìç S·ª≠ D·ª•ng V·ªã Tr√≠ Hi·ªán T·∫°i</button>
        </div>

        <div class="input-group">
            <label for="searchInput">Ho·∫∑c t√¨m ki·∫øm ƒë·ªãa ch·ªâ:</label>
            <input type="text" id="searchInput" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ (VD: Qu·∫≠n 1, TP.HCM)">
            <div id="suggestions" class="suggestions"></div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            ƒêang t·∫£i th√¥ng tin ph∆∞·ªùng x√£...
        </div>

        <div id="result" class="result"></div>
    </div>

    <script defer>
        let wardData = null;
        let searchTimeout = null;
        let dataLoaded = false;

        // Load ward data from GitHub
        async function loadWardData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/lqtue/phuongnao/main/Data.geojson');
                wardData = await response.json();
                return wardData;
            } catch (error) {
                console.error('Error loading ward data:', error);
                showResult('L·ªói t·∫£i d·ªØ li·ªáu ph∆∞·ªùng x√£. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.', true);
            }
        }

        // Check if point is inside polygon using ray casting algorithm
        function pointInPolygon(point, polygon) {
            const [x, y] = point;
            let inside = false;
            
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const [xi, yi] = polygon[i];
                const [xj, yj] = polygon[j];
                
                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            
            return inside;
        }

        // Calculate centroid of a Polygon / MultiPolygon (very light‚Äëweight)
        function getCentroid(geometry) {
            let coords = [];
            if (geometry.type === 'Polygon') {
                coords = geometry.coordinates[0];
            } else if (geometry.type === 'MultiPolygon') {
                coords = geometry.coordinates[0][0];
            }
            let sumX = 0, sumY = 0;
            coords.forEach(([x, y]) => {
                sumX += x;
                sumY += y;
            });
            const len = coords.length || 1;
            return { lat: sumY / len, lng: sumX / len };
        }

        // Find ward for given coordinates
        async function findWard(lat, lng) {
            if (!dataLoaded) {
                await loadWardData();
                dataLoaded = true;
            }
            if (!wardData) {
                showResult('D·ªØ li·ªáu ph∆∞·ªùng x√£ ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i.', true);
                return;
            }

            const point = [lng, lat]; // GeoJSON uses [longitude, latitude]

            for (let i = 0; i < wardData.features.length; i++) {
                const feature = wardData.features[i];
                const geometry = feature.geometry;
                const properties = feature.properties;

                if (geometry.type === 'Polygon') {
                    if (pointInPolygon(point, geometry.coordinates[0])) {
                        showResult('', false, properties, geometry);
                        return;
                    }
                } else if (geometry.type === 'MultiPolygon') {
                    for (const polygon of geometry.coordinates) {
                        if (pointInPolygon(point, polygon[0])) {
                            showResult('', false, properties, geometry);
                            return;
                        }
                    }
                }
            }

            showResult(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y v·ªã tr√≠ (${lat}, ${lng}) trong ranh gi·ªõi ph∆∞·ªùng x√£ hi·ªán t·∫°i. C√≥ th·ªÉ b·∫°n ƒëang ·ªü ngo√†i khu v·ª±c TP.HCM ho·∫∑c khu v·ª±c ƒë∆∞·ª£c bao ph·ªß.`, true);
        }

        // Helper function to extract ward name from properties
        function getWardName(properties) {
            // Try different possible property names, including Vietnamese names
            const possibleNames = [
                'ƒêHVC m·ªõi', // New Administrative Division (Vietnamese)
                'name', 'NAME', 'Name',
                'ward_name', 'WARD_NAME', 'wardName',
                'full_name', 'FULL_NAME', 'fullName',
                'ten_phuong', 'TEN_PHUONG',
                'label', 'LABEL',
                'title', 'TITLE'
            ];

            for (const prop of possibleNames) {
                if (properties[prop]) {
                    return properties[prop];
                }
            }

            // If no standard name found, return the first available property value
            const values = Object.values(properties);
            if (values.length > 0 && values[0]) {
                return values[0];
            }

            return 'Ph∆∞·ªùng x√£ kh√¥ng x√°c ƒë·ªãnh';
        }

        // Display result (error or feature details)
        function showResult(message = '', isError = false, properties = null, geometry = null) {
            const resultDiv = document.getElementById('result');

            if (isError || !properties) {
                resultDiv.innerHTML = message;
                resultDiv.className = 'result error';
                resultDiv.style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            resultDiv.innerHTML = createWardInfoHTML(properties, geometry);
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Build ward information panel directly from GeoJSON properties
        function createWardInfoHTML(props, geometry) {
            // Helper getters with graceful fallback
            const get = (key, alt = 'ƒêang c·∫≠p nh·∫≠t...') => (props[key] !== undefined && props[key] !== null && props[key] !== '') ? props[key] : alt;

            const wardName   = get('ƒêHVC m·ªõi', getWardName(props));
            const shortName  = get('T√™n vi·∫øt t·∫Øt');
            const truSo      = get('Tr·ª• s·ªü');
            const matDo      = get('M·∫≠t ƒë·ªô (ng∆∞·ªùi/km2)', get('M·∫≠t ƒë·ªô'));
            const danSo      = get('D√¢n s·ªë (ngh√¨n ng∆∞·ªùi)', get('D√¢n s·ªë'));
            const dienTich   = get('Di·ªán t√≠ch (km2)', get('Di·ªán t√≠ch'));
            const sapNhap    = get('S√°p nh·∫≠p t·ª´');
            const quanHuyen  = get('Qu·∫≠n huy·ªán');
            const centroid   = getCentroid(geometry);

            return `
                <div class="ward-info">
                    <div class="ward-name">üìç ${wardName}</div>
                    <table class="ward-table">
                        <tr><th>ƒêHVC m·ªõi</th><td>${wardName}</td></tr>
                        <tr><th>T√™n vi·∫øt t·∫Øt</th><td>${shortName}</td></tr>
                        <tr><th>Tr·ª• s·ªü</th><td>${truSo}</td></tr>
                        <tr><th>M·∫≠t ƒë·ªô (ng∆∞·ªùi/km¬≤)</th><td>${matDo}</td></tr>
                        <tr><th>D√¢n s·ªë (ngh√¨n ng∆∞·ªùi)</th><td>${danSo}</td></tr>
                        <tr><th>Di·ªán t√≠ch (km¬≤)</th><td>${dienTich}</td></tr>
                        <tr><th>S√°p nh·∫≠p t·ª´</th><td>${sapNhap}</td></tr>
                        <tr><th>Qu·∫≠n huy·ªán</th><td>${quanHuyen}</td></tr>
                    </table>
                    <button class="directions-btn" onclick="getDirections('${wardName}', ${centroid.lat}, ${centroid.lng})">
                        üß≠ Ch·ªâ ƒë∆∞·ªùng ƒë·∫øn tr·ª• s·ªü
                    </button>
                </div>
            `;
        }

        // Open Google¬†Maps directions (mobile‚Äëfriendly)
        function getDirections(wardName, lat, lng) {
            // Google¬†Maps universal URL format:
            // https://www.google.com/maps/dir/?api=1&origin=LAT,LNG&destination=LAT,LNG
            const openMaps = (originLat = null, originLng = null) => {
                const base = 'https://www.google.com/maps/dir/?api=1';
                const origin  = originLat !== null && originLng !== null
                                ? `&origin=${originLat},${originLng}`
                                : '';
                const destination = `&destination=${lat},${lng}`;
                const url = `${base}${origin}${destination}&travelmode=driving`;
                // Use a full redirect instead of window.open to avoid popup blockers on mobile
                window.location.href = url;
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => openMaps(pos.coords.latitude, pos.coords.longitude),
                    ()   => openMaps()          // fallback: destination only
                );
            } else {
                openMaps();                      // no geolocation support
            }
        }

        // Get current location
        document.getElementById('locationBtn').addEventListener('click', async () => {
            if (!navigator.geolocation) {
                showResult('Geolocation is not supported by this browser.', true);
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    await findWard(lat, lng);
                },
                (error) => {
                    let errorMessage = 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n. ';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Quy·ªÅn truy c·∫≠p v·ªã tr√≠ ƒë√£ b·ªã t·ª´ ch·ªëi.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Th√¥ng tin v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Y√™u c·∫ßu v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian ch·ªù.';
                            break;
                        default:
                            errorMessage += 'ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.';
                            break;
                    }
                    showResult(errorMessage, true);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });

        // Search functionality using Nominatim
        async function searchLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=vn`);
                const results = await response.json();
                return results;
            } catch (error) {
                console.error('Search error:', error);
                return [];
            }
        }

        // Handle search input
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 3) {
                document.getElementById('suggestions').style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                const results = await searchLocation(query);
                showSuggestions(results);
            }, 300);
        });

        // Show search suggestions
        function showSuggestions(results) {
            const suggestionsDiv = document.getElementById('suggestions');
            
            if (results.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            suggestionsDiv.innerHTML = '';
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = result.display_name;
                item.addEventListener('click', async () => {
                    document.getElementById('searchInput').value = result.display_name;
                    suggestionsDiv.style.display = 'none';
                    
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('result').style.display = 'none';
                    
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    await findWard(lat, lng);
                });
                suggestionsDiv.appendChild(item);
            });

            suggestionsDiv.style.display = 'block';
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#searchInput') && !e.target.closest('#suggestions')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });

    </script>
</body>
</html>
